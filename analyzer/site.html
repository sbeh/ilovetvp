<!DOCTYPE html>
<html>
    <head>
        <title>ilovetvp</title>
        <script type="text/javascript" src="smoothie.js"></script>
        <script type="text/javascript">
            function status(message) {
                delete graph;

                document.body.innerHTML = message;
            }

            var http = new XMLHttpRequest();

            function request() {
                http.open('GET', 'oneshot');
                http.send();
            }
            
            var graph;

            var timeseries = {};
            timeseries.addAll = function () {
                var ignore = ['addAll', 'add', 'get'];

                Object.keys(this).forEach(function (weapon) {
                    if (ignore.indexOf(weapon) === -1)
                        this.add(weapon);
                });
            }
            timeseries.add = function (weapon) {
                if (typeof graph !== 'undefined') {
                    var colors = ['Blue', 'Aqua', 'Green', 'Yellow', 'Fuchsia', 'Purple'];
                    graph.addTimeSeries(
                        this[weapon],
                        {
                            strokeStyle: colors[
                                Math.min(
                                    Object.keys(this).length - 3/*addAll,add,get*/,
                                    colors.length) %
                                colors.length
                            ]
                        });
                }
            };
            timeseries.get = function (weapon) {
                if (typeof this[weapon] === 'undefined') {
                    this[weapon] = new TimeSeries();

                    this.add(weapon);
                }

                return this[weapon];
            };

            function process(json) {
                for (var i = 1; i < json.length; ++i) {
                    var timestamp = Date.parse(json[i][0]);
                    var damage = json[i][1];
                    var weapon = json[i][2];

                    timeseries.get(weapon).append(timestamp, damage);
                }
            }

            function receive() {
                if (http.readyState == 4) {
                    if (http.status == 200) {
                        try {
                            var json = null;
                            if (typeof http.response === 'undefined') {
                                if (http.responseText.length > 0)
                                    json = JSON.parse(http.responseText);
                            } else
                                json = http.response;

                            if (json === null)
                                status('HTTP Response empty');
                            else {
                                if (typeof graph === 'undefined') {
                                    graph = new SmoothieChart({
                                        millisPerPixel: 100,
                                        interpolation: 'dot',
                                        grid: {
                                            millisPerLine: 5000,
                                            verticalSections: 7,
                                            borderVisible: false
                                        },
                                        minValue: 0
                                    });

                                    document.body.innerHTML = '<canvas id="graph" />';

                                    resize();

                                    graph.streamTo(document.getElementById('graph'));

                                    timeseries.addAll();
                                }

                                process(json);
                            }
                        } catch (e) {
                            status('Exception: ' + e.message + '<br/>Response: ' + http.responseText);
                        }
                    } else
                        status('HTTP Return code unexpected: ' + http.status);

                    setTimeout(request, 100);
                }
            }

            window.onload = function () {
                http.onreadystatechange = receive;
                request();

                if (typeof CCPEVE === 'undefined')
                    return;

                status('Waiting for user to set this website as trustworthy.');

                CCPEVE.requestTrust('http://ilovetvp.serverstaff.de:47617/');
            };

            var resizeTimer;

            function resize() {
                if (typeof resizeTimer !== 'undefined')
                    delete resizeTimer;

                var canvas = document.getElementById('graph');
                if (canvas !== null) {
                    canvas.height = window.innerHeight - 4;
                    canvas.width = window.innerWidth;
                }
            }

            window.onresize = function () {
                if (typeof resizeTimer !== 'undefined')
                    clearTimeout(resizeTimer);

                resizeTimer = setTimeout(resize, 500);
            };
        </script>
        <style>
            * {
                margin: 0;
                border: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        Please open this website in your EVE client's browser.
    </body>
</html>