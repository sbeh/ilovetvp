<!DOCTYPE html>
<html>
    <head>
        <title>ilovetvp</title>
        <script type="text/javascript" src="smoothie.js"></script>
        <script type="text/javascript">
            function status(message) {
                delete graph;

                document.body.innerHTML = message;
            }

            var http;

            function request() {
                if (typeof CCPEVE === 'undefined')
                    http.open('GET', 'oneshot_random');
                else
                    http.open('GET', 'oneshot');
                http.send();
            }
            
            var graph;

            var timeseries = {};
            timeseries.weapons = [];
            timeseries.isEmpty = function () {
                return this.weapons.length === 0;
            }
            timeseries.addAll = function () {
                this.weapons.forEach(this.add);
            }
            timeseries.add = function (weapon) {
                if (typeof graph !== 'undefined') {
                    var colors = ['Blue', 'Aqua', 'Green', 'Yellow', 'Fuchsia', 'Purple'];
                    graph.addTimeSeries(
                        this[weapon],
                        {
                            strokeStyle: colors[
                                Math.min(
                                    Object.keys(this).length - this.ignore.length,
                                    colors.length) %
                                colors.length
                            ]
                        });
                }
            };
            timeseries.get = function (weapon) {
                if (typeof this[weapon] === 'undefined') {
                    this.weapons.push(weapon);
                    this[weapon] = new TimeSeries();

                    this.add(weapon);
                }

                return this[weapon];
            };

            function process(json) {
                for (var i = 1; i < json.length; ++i) {
                    var timestamp = Date.parse(json[i][0]);
                    var damage = json[i][1];
                    var weapon = json[i][2];

                    timeseries.get(weapon).append(timestamp, damage);
                }
            }

            function receive() {
                if (http.readyState == 4) {
                    if (http.status == 200) {
                        try {
                            var json = null;
                            if (typeof http.response === 'undefined') {
                                if (http.responseText.length > 0)
                                    json = JSON.parse(http.responseText);
                            } else
                                json = http.response;

                            if (json === null) {
                                if(timeseries.isEmpty())
                                    status(
                                        'Start "ilovetvp.exe" to transmit game log.<br />' +
                                        'You need to download this tool with your out of game browser.<br />' +
                                        'Please use the follow link to download:<br /><br />' +
                                        '<pre>https://github.com/sbeh/ilovetvp/blob/master/ilovetvp/bin/Release/ilovetvp.exe?raw=true</pre>'
                                    );
                                else
                                    status('HTTP Response empty');
                            } else {
                                if (typeof graph === 'undefined') {
                                    graph = new SmoothieChart({
                                        millisPerPixel: 100,
                                        interpolation: 'dot',
                                        grid: {
                                            millisPerLine: 5000,
                                            verticalSections: 7,
                                            borderVisible: false
                                        },
                                        minValue: 0
                                    });

                                    document.body.innerHTML = '<canvas id="graph" />';

                                    resize();

                                    graph.streamTo(document.getElementById('graph'));

                                    timeseries.addAll();
                                }

                                process(json);
                            }
                        } catch (e) {
                            try {
                                status('Exception: <pre>' + (typeof e.stack === 'undefined' ? e : e.stack) + '</pre><br/>Response: ' + http.responseText);
                            } catch(e_) {
                                status('Exception: <pre>' + (typeof e.stack === 'undefined' ? e : e.stack) + '</pre>');
                            }
                        }
                    } else if (http.status === 401)
                            ;
                    else
                        status('HTTP Return code unexpected: ' + http.status);

                    setTimeout(request, 100);
                }
            }

            window.onload = function () {
                http = new XMLHttpRequest();
                http.responseType = "json";
                http.onreadystatechange = receive;
                request();

                if (typeof CCPEVE === 'undefined')
                    return;

                status('Waiting for user to set this website as trustworthy.');

                CCPEVE.requestTrust('http://ilovetvp.serverstaff.de:47617/');
            };

            var resizeTimer;

            function resize() {
                if (typeof resizeTimer !== 'undefined') {
                    clearTimeout(resizeTimer);

                    delete resizeTimer;
                }

                var canvas = document.getElementById('graph');
                if (canvas !== null) {
                    canvas.height = window.innerHeight - 4;
                    canvas.width = window.innerWidth;
                }
            }

            window.onresize = function () {
                if (typeof resizeTimer !== 'undefined')
                    clearTimeout(resizeTimer);

                resizeTimer = setTimeout(resize, 500);
            };
        </script>
        <style>
            * {
                margin: 0;
                border: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        Please open this website in your EVE client's browser.
    </body>
</html>